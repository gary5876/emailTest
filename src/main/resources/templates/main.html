<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>동아리 지원 폼</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 760px; margin: 24px auto; line-height: 1.6; }
        label { display:block; margin: 12px 0 6px; color:#374151; }
        input[type="text"], input[type="email"], textarea { width:100%; padding:10px; border:1px solid #e5e7eb; border-radius:10px; max-width: 720px; }
        .q { margin-bottom: 16px; }
        .large { max-width:720px; }
        .opts { display:flex; gap:14px; flex-wrap:wrap; }
        .opt { display:flex; align-items:center; gap:6px; }
        .meta { padding:12px; border:1px dashed #d1d5db; border-radius:10px; margin-bottom: 18px; }
        button { margin-top:16px; padding:10px 16px; border-radius:10px; border:0; cursor:pointer; }
        small.req { color:#ef4444; margin-left:6px; }
    </style>
</head>
<body>
<h2>동아리 지원 폼</h2>

<div class="meta">
    <div class="q">
        <label>이름 *</label>
        <input id="applicantName" maxlength="50" required />
    </div>
    <div class="q">
        <label>이메일 *</label>
        <input id="applicantEmail" type="email" required />
    </div>
    <div class="q">
        <label>지원 동아리 *</label>
        <input id="clubName" maxlength="100" required />
    </div>
    <div class="q">
        <label>메일 제목(선택)</label>
        <input id="subject" maxlength="200" placeholder="미입력 시 자동 생성" />
    </div>
    <div class="large">
        <label>질문1 *</label>
        <textarea id="paragraph1" rows="5" required></textarea>
    </div>
    <div class="large">
        <label>질문2 *</label>
        <textarea id="paragraph2" rows="5" required ></textarea>
    </div>
</div>

<!-- 동적 질문 영역 -->
<form id="applyForm">
    <div th:each="q : ${questions}" class="q">
        <label th:attr="for=${q.id}">
            <span th:text="${q.label}">질문</span>
            <small th:if="${q.required}" class="req">*</small>
        </label>

        <div th:switch="${q.type}">
            <!-- TEXT -->
            <div th:case="'TEXT'">
                <textarea th:attr="id=${q.id}" rows="4" th:attrappend="${q.required} ? ' required' : ''"></textarea>
            </div>

            <!-- CHECKBOX -->
            <div th:case="'CHECKBOX'" class="opts">
                <label class="opt" th:each="opt : ${q.options}">
                    <input type="checkbox" th:attr="name=${q.id}" th:value="${opt}" />
                    <span th:text="${opt}">옵션</span>
                </label>
            </div>

            <!-- RADIO -->
            <div th:case="'RADIO'" class="opts">
                <label class="opt" th:each="opt : ${q.options}">
                    <input type="radio" th:attr="name=${q.id}" th:value="${opt}" />
                    <span th:text="${opt}">옵션</span>
                </label>
            </div>
        </div>
    </div>

    <div class="q">
        <label>첨부파일(선택, 여러 개 가능)</label>
        <input id="files" type="file" multiple />
    </div>

    <button type="submit">지원서 보내기</button>
    <div id="result" aria-live="polite"></div>
</form>

<script>
    const form = document.getElementById('applyForm');
    const result = document.getElementById('result');

    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const linksRaw = document.getElementById('portfolioLinks').value.trim();
        const links = linksRaw
            ? linksRaw.split(/\r?\n/).map(s => s.trim()).filter(Boolean)
            : [];

        const payload = {
            applicantName:  document.getElementById('applicantName').value.trim(),
            applicantEmail: document.getElementById('applicantEmail').value.trim(),
            clubName:       document.getElementById('clubName').value.trim(),
            subject:        document.getElementById('subject').value.trim(),
            paragraph1:     document.getElementById('paragraph1').value.trim(),
            paragraph2:     document.getElementById('paragraph2').value.trim(),
            answers: []
        };

        for (const k of ['applicantName','applicantEmail','clubName','paragraph1','paragraph2']) {
            if (!payload[k]) {
                result.textContent = '필수 항목을 모두 입력해 주세요.';
                result.style.color = 'crimson';
                return;
            }
        }

        // 2) 화면의 질문들을 수집
        //   서버 렌더된 questions를 data-* 로 전달해도 되고, DOM을 직접 읽어도 됨.
        //   여기서는 DOM을 스캔해서 수집.
        const questionBlocks = document.querySelectorAll('[th\\:each]'); // (Thymeleaf 태그는 렌더 후 사라짐)
        // 대신, input/textarea 들을 기반으로 수집:
        const seen = new Set();
        document.querySelectorAll('textarea, input[type="checkbox"], input[type="radio"]').forEach(el => {
            const name = el.getAttribute('name') || el.id;
            if (!name) return;
            if (seen.has(name)) return; // 질문 단위로 1번만 처리(체크박스는 아래에서 findAll)
            seen.add(name);

            // label 텍스트 추출
            const labelEl = document.querySelector(`label[for="${name}"]`) || el.closest('.q')?.querySelector('label');
            const label = labelEl ? labelEl.textContent.replace('*','').trim() : name;

            // 타입 판별
            const radios = document.querySelectorAll(`input[type="radio"][name="${name}"]`);
            const checks = document.querySelectorAll(`input[type="checkbox"][name="${name}"]`);
            if (radios.length) {
                const selected = Array.from(radios).find(r => r.checked)?.value || "";
                payload.answers.push({ questionId: name, label, type: "RADIO", value: selected, values: null });
            } else if (checks.length) {
                const values = Array.from(checks).filter(c => c.checked).map(c => c.value);
                payload.answers.push({ questionId: name, label, type: "CHECKBOX", value: null, values });
            } else {
                const text = document.getElementById(name)?.value || "";
                payload.answers.push({ questionId: name, label, type: "TEXT", value: text, values: null });
            }
        });

        // 3) multipart/form-data로 포장
        const fd = new FormData();
        fd.append('form', new Blob([JSON.stringify(payload)], {type:'application/json'}));
        for (const f of document.getElementById('files').files) fd.append('files', f, f.name);

        try {
            const res = await fetch('/api/applications/send', { method:'POST', body: fd });
            if (!res.ok) throw new Error(await res.text());
            result.textContent = '전송 완료!'; result.style.color='green'; form.reset();
        } catch (e2) {
            result.textContent = '전송 실패: ' + e2.message; result.style.color='crimson';
        }
    });
</script>
</body>
</html>
