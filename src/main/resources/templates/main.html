<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>동아리 지원 폼</title>
    <style>
        body { font-family: Arial, sans-serif; line-height: 1.5; max-width: 720px; margin: 24px auto; }
        label { display:block; margin: 12px 0 4px; color:#374151; }
        input, textarea { width:100%; padding:10px; border:1px solid #e5e7eb; border-radius:10px; }
        small { color:#6b7280; }
        .row { display:flex; gap:12px; }
        .row > div { flex:1; }
        button { margin-top:16px; padding:10px 16px; border-radius:10px; border:0; cursor:pointer; }
    </style>
</head>
<body>
<h2>동아리 지원 폼</h2>

<form id="applyForm">
    <div class="row">
        <div>
            <label>이름 *</label>
            <input id="applicantName" maxlength="50" required/>
        </div>
        <div>
            <label>이메일 *</label>
            <input id="applicantEmail" type="email" required/>
        </div>
    </div>

    <label>지원 동아리 *</label>
    <input id="clubName" maxlength="100" required/>

    <label>메일 제목(선택)</label>
    <input id="subject" maxlength="200" placeholder="미입력 시 규칙대로 자동 생성"/>

    <label>질문1 *</label>
    <textarea id="paragraph1" rows="5" required></textarea>

    <label>질문2 *</label>
    <textarea id="paragraph2" rows="5" required></textarea>

    <label>포트폴리오 링크(선택, 줄바꿈으로 여러 개)</label>
    <textarea id="portfolioLinks" rows="3" placeholder="https://github.com/..., https://..."></textarea>

    <label>첨부파일(선택, 여러 개 가능)</label>
    <input id="files" type="file" multiple/>

    <button type="submit">지원서 보내기</button>
    <div id="result" aria-live="polite"></div>
</form>

<script>
    const form = document.getElementById('applyForm');
    const result = document.getElementById('result');

    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const linksRaw = document.getElementById('portfolioLinks').value.trim();
        const links = linksRaw
            ? linksRaw.split(/\r?\n/).map(s => s.trim()).filter(Boolean)
            : [];

        const payload = {
            applicantName:  document.getElementById('applicantName').value.trim(),
            applicantEmail: document.getElementById('applicantEmail').value.trim(),
            clubName:       document.getElementById('clubName').value.trim(),
            subject:        document.getElementById('subject').value.trim(),
            paragraph1:     document.getElementById('paragraph1').value.trim(),
            paragraph2:     document.getElementById('paragraph2').value.trim(),
            portfolioLinks: links
        };

        for (const k of ['applicantName','applicantEmail','clubName','paragraph1','paragraph2']) {
            if (!payload[k]) {
                result.textContent = '필수 항목을 모두 입력해 주세요.';
                result.style.color = 'crimson';
                return;
            }
        }

        // 2) multipart/form-data 작성
        const fd = new FormData();
        // form 파트: JSON Blob
        fd.append('form', new Blob([JSON.stringify(payload)], {type: 'application/json'}));

        // files 파트: 다중 첨부
        const files = document.getElementById('files').files;
        for (const f of files) fd.append('files', f, f.name);

        // 3) 전송
        try {
            const res = await fetch('/api/applications/send', {
                method: 'POST',
                body: fd
            });

            if (!res.ok) {
                const text = await res.text();
                throw new Error(text || ('HTTP ' + res.status));
            }
            result.textContent = '전송 완료!';
            result.style.color = 'green';
            form.reset();
        } catch (err) {
            result.textContent = '전송 실패: ' + err.message;
            result.style.color = 'crimson';
        }
    });
</script>
</body>
</html>
